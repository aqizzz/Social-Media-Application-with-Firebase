@inject string FirebaseConfig
@{
    ViewData["Title"] = "Change Password";
}

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js';
    import { getAuth, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js';

    const firebaseConfig = @Html.Raw(FirebaseConfig);

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    document.getElementById('changePasswordButton').addEventListener('click', () => {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;

        if (newPassword !== confirmNewPassword) {
            alert('New passwords do not match');
            return;
        }

        const user = auth.currentUser;
        if (user) {
            // Reauthenticate user
            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            reauthenticateWithCredential(user, credential)
                .then(() => {
                    // Reauthentication successful, now update the password
                    updatePassword(user, newPassword)
                        .then(() => {
                            alert('Password updated successfully');
                            window.location.href = '/Auth/EditProfile';
                        })
                        .catch((error) => {
                            console.error('Error updating password:', error);
                            alert('Error updating password');
                        });
                })
                .catch((error) => {
                    console.error('Error reauthenticating:', error);
                    alert('Error reauthenticating');
                });
        } else {
            alert('No user is currently signed in');
        }
    });
</script>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card mt-5">
                <div class="card-body">
                    <h2 class="card-title text-center">Change Password</h2>
                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label for="currentPassword">Current Password:</label>
                            <input type="password" id="currentPassword" class="form-control" required />
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password:</label>
                            <input type="password" id="newPassword" class="form-control" minlength="6" required />
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirm New Password:</label>
                            <input type="password" id="confirmNewPassword" class="form-control" minlength="6" required />
                        </div>
                        <br />
                        <div class="text-center">
                            <button type="button" id="changePasswordButton" class="btn btn-primary">Change Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
